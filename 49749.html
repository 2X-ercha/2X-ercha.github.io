<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>rust写个操作系统——课程实验blogos移至armV8深度解析：实验八上 内存管理 | 贰猹の小窝</title><meta name="keywords" content="Course,os,rust,blogos"><meta name="author" content="noionion"><meta name="copyright" content="noionion"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="HNU 操作系统课程实验：将 blogos 移植到 armv8 架构。"><meta property="og:type" content="article"><meta property="og:title" content="rust写个操作系统——课程实验blogos移至armV8深度解析：实验八上 内存管理"><meta property="og:url" content="https://noionion.top/49749.html"><meta property="og:site_name" content="贰猹の小窝"><meta property="og:description" content="HNU 操作系统课程实验：将 blogos 移植到 armv8 架构。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/deemo_for_cover/13.jpg"><meta property="article:published_time" content="2022-06-08T23:01:00.000Z"><meta property="article:modified_time" content="2022-06-08T23:01:00.000Z"><meta property="article:author" content="noionion"><meta property="article:tag" content="Course"><meta property="article:tag" content="os"><meta property="article:tag" content="rust"><meta property="article:tag" content="blogos"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/deemo_for_cover/13.jpg"><link rel="shortcut icon" href="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/img/head.jpg"><link rel="canonical" href="https://noionion.top/49749"><link rel="preconnect" href="//cdn1.tianli0.top"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.sourcegcdn.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{jQuery:"https://cdnjs.sourcegcdn.com/ajax/libs/jquery/3.6.0/jquery.min.js",justifiedGallery:{js:"https://cdnjs.sourcegcdn.com/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js",css:"https://cdnjs.sourcegcdn.com/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"},fancybox:{js:"https://cdnjs.sourcegcdn.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",css:"https://cdnjs.sourcegcdn.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-06-08 23:01:00"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){0!==o&&(o=864e5*o,t={value:t,expiry:(new Date).getTime()+o},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=a=>new Promise((t,e)=>{const o=document.createElement("script");o.src=a,o.async=!0,o.onerror=e,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme");"dark"===e?activateDarkMode():"light"===e&&activateLightMode()})(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload='this.media="all"'><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="贰猹の小窝" type="application/atom+xml"><link rel="alternate" href="/rss.xml" title="贰猹の小窝" type="application/rss+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="simply-cha-top"></div><div class="is-center" id="sidebar-avatar"><div class="avatar-img"><img src="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/img/head.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">noionion</div><div class="author-info__description">欢迎光临小窝！</div></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/2X-ercha"><i class="fab fa-github"></i><span> Follow Me</span></a><div class="menu-info-social-icons is-center"><a class="social-icon" href="https://github.com/2X-ercha" target="_blank" title="Github"><i class="fa-fw fab fa-github"></i></a><a class="social-icon" href="mailto:noionion@outlook.com" target="_blank" title="Email"><i class="fa-fw fas fa-envelope"></i></a><a class="social-icon" href="/rss.xml" target="_blank" title="rss"><i class="fa-fw fas fa-rss"></i></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua1"></use></svg><span>甜瓜待摘</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-45px"><li><a class="site-page child" href="/tags/Course/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-jiaocheng"></use></svg><span>教程分享</span></a></li><li><a class="site-page child" href="/tags/Project/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiangmu"></use></svg><span>自制项目</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-miao"></use></svg><span>种瓜日记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-100px"><li><a class="site-page child" href="/tags/C/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>搓搓C++</span></a></li><li><a class="site-page child" href="/tags/Python/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>玩玩爬虫</span></a></li><li><a class="site-page child" href="/tags/html/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>摸摸前端</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-tea"></use></svg><span>生活日常</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-100px"><li><a class="site-page child" href="/link/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-pengyou"></use></svg><span>友情链接</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.noionion.cn/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-pengyouquanzhushou2x"></use></svg><span>随便说说</span></a></li><li><a class="site-page child" href="/messageboard/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-shuoshuo-"></use></svg><span>留言信箱</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-liuyan"></use></svg><span>猹的哔哔</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-45px"><li><a class="site-page child" href="/tags/Diary/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span>贰猹随笔</span></a></li><li><a class="site-page child" href="/about/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span>猹的自述</span></a></li></ul></div></div><div class="simply-cha"></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/">贰猹の小窝</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua1"></use></svg><span>甜瓜待摘</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-45px"><li><a class="site-page child" href="/tags/Course/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-jiaocheng"></use></svg><span>教程分享</span></a></li><li><a class="site-page child" href="/tags/Project/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xiangmu"></use></svg><span>自制项目</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-miao"></use></svg><span>种瓜日记</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-100px"><li><a class="site-page child" href="/tags/C/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>搓搓C++</span></a></li><li><a class="site-page child" href="/tags/Python/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>玩玩爬虫</span></a></li><li><a class="site-page child" href="/tags/html/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-colorful-code"></use></svg><span>摸摸前端</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-tea"></use></svg><span>生活日常</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-100px"><li><a class="site-page child" href="/link/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-pengyou"></use></svg><span>友情链接</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.noionion.cn/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-pengyouquanzhushou2x"></use></svg><span>随便说说</span></a></li><li><a class="site-page child" href="/messageboard/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-shuoshuo-"></use></svg><span>留言信箱</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-liuyan"></use></svg><span>猹的哔哔</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child" style="left:-45px"><li><a class="site-page child" href="/tags/Diary/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-tubiaozhizuomoban-"></use></svg><span>贰猹随笔</span></a></li><li><a class="site-page child" href="/about/"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xinfeng"></use></svg><span>猹的自述</span></a></li></ul></div></div></div><div id="navFn"><div id="search-button"><a class="social-icon search"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-sousuo"></use></svg><span>搜索</span></a></div><div id="darkmodeBt"><a class="darkmode switch"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-deng1"></use></svg><span id="darkmode-switch">关灯</span></a></div><div id="toggle-menu"><a class="site-page"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mulu"></use></svg></a></div></div></div></nav></header><div id="mainbody"><div id="content_leftside"><div id="left_menu"><div class="leftside-social"><a class="social-icon" href="https://github.com/2X-ercha" target="_blank" title="Github"><i class="fa-fw fab fa-github"></i></a><a class="social-icon" href="mailto:noionion@outlook.com" target="_blank" title="Email"><i class="fa-fw fas fa-envelope"></i></a><a class="social-icon" href="/rss.xml" target="_blank" title="rss"><i class="fa-fw fas fa-rss"></i></a></div><div class="leftside-contents"><span id="read-percent">0</span></div><div class="leftside-comment"><a href="#post-comment" title="要去留言吗？"><i class="fa-lg fas fa-comment"></i></a></div><div class="leftside-qq" title="来糖果屋聊天噻！"><i class="fa-lg fas fa-qrcode"></i></div><div class="leftside-rmb"><a title="柿还在施工的捐赠页！不给看！"><i class="fa-lg fas fa-money-check-dollar"></i></a></div></div><div id="left_display"><div class="candy_qrcode"><img src="./img/candy-qr.png"></div></div></div><main class="layout hide-aside" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">rust写个操作系统——课程实验blogos移至armV8深度解析：实验八上 内存管理</h1><div id="post-meta"><div class="tag-cloud-list is-center"><a href="/tags/Course/" style="font-size:1.8em;color:#a8318a">Course</a><a href="/tags/os/" style="font-size:1.5em;color:#399098">os</a><a href="/tags/rust/" style="font-size:1.5em;color:#95a896">rust</a><a href="/tags/blogos/" style="font-size:1.5em;color:#0e6a58">blogos</a></div><div class="meta-firstline"><span class="post-meta-date"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-08T23:01:00.000Z" title="发表于 2022-06-08 23:01:00">2022-06-08</time><span class="post-meta-separator">|</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-shijian"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-08T23:01:00.000Z" title="更新于 2022-06-08 23:01:00">2022-06-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-fenlei1"></use></svg><a class="post-meta-categories" href="/categories/BlogOS-armv8/">BlogOS_armv8</a></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>21分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="rust写个操作系统——课程实验blogos移至armV8深度解析：实验八上 内存管理"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div><div class="line"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg></div></div></div><article class="post-content" id="article-container"><div class="note info flat"><blockquote><p>你将在每个实验对应分支上都看到这句话，确保作者实验代码在被下载后，能在正确的环境中运行。</p></blockquote><p>运行环境请参考: <a href="https://noionion.top/adfdff.html">lab1 环境搭建</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cargo build</span><br><span class="line">qemu-system-aarch64 -machine virt -m 1024M -cpu cortex-a53 -nographic -kernel target/aarch64-unknown-none-softfloat/debug/blogos_armv8 -semihosting</span><br></pre></td></tr></table></figure></div><h2 id="实验八-内存管理（上）"><a href="#实验八-内存管理（上）" class="headerlink" title="实验八 内存管理（上）"></a>实验八 内存管理（上）</h2><p>第一部分：使用<code>identity mapping</code>直接映射</p><p>虚拟地址的转换很容易出错也很难调试，所以我们从最简单方式开始，即<code>identity mapping</code>，所谓<code>identity mapping</code>就是将虚拟地址映射到相同的物理地址，然后再做进一步偏移尝试</p><hr><h3 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h3><p>实验指导书这么写的，全面理解分页式内存管理的基本方法以及访问页表，完成地址转换等的方法。这部分我也不太能搞懂，所以还是按它说的来吧。</p><hr><h3 id="使用identity-mapping映射（无偏移的映射）"><a href="#使用identity-mapping映射（无偏移的映射）" class="headerlink" title="使用identity mapping映射（无偏移的映射）"></a>使用identity mapping映射（无偏移的映射）</h3><p>虚拟地址的转换很容易出错也很难调试，所以我们从最简单方式开始，即<code>identity mapping</code>，所谓<code>identity mapping</code>就是将虚拟地址映射到相同的物理地址。</p><p>首先要明确的是，我们内核和外设的物理地址，是不会随着我们改变内核文件就更改地址的（这由机器硬件设备决定）。我们所有的内核内存修改，均修改的是虚拟内存。</p><p>我们首先需要了解的是<code>qemu</code>模拟的<code>virt</code>机器：（以下引自清华rcore的实验指导书：<a target="_blank" rel="noopener" href="https://rcore-os.github.io/rCore-Tutorial-Book-v3/chapter1/3first-instruction-in-kernel1.html">《rCore-Tutorial-Book 第三版》第一章：应用程序与基本执行环境 » 内核第一条指令（原理篇）</a>）</p><blockquote><p>virt 平台上，物理内存的起始物理地址为 0x80000000 ，物理内存的默认大小为 128MiB ，它可以通过 -m 选项进行配置。在本书中，我们只会用到最低的 8MiB 物理内存，对应的物理地址区间为 [0x80000000,0x80800000) 。</p><p>为什么加载到这两个位置呢？这与 Qemu 模拟计算机加电启动后的运行流程有关。一般来说，计算机加电之后的启动流程可以分成若干个阶段，每个阶段均由一层软件负责，每一层软件的功能是进行它应当承担的初始化工作，并在此之后跳转到下一层软件的入口地址，也就是将计算机的控制权移交给了下一层软件。Qemu 模拟的启动流程则可以分为三个阶段：第一个阶段由固化在 Qemu 内的一小段汇编程序负责；第二个阶段由 bootloader 负责；第三个阶段则由内核镜像负责。</p><ul><li><p>第一阶段：将必要的文件载入到 Qemu 物理内存之后，Qemu CPU 的程序计数器（PC, Program Counter）会被初始化为 0x1000 ，因此 Qemu 实际执行的第一条指令位于物理地址 0x1000 ，接下来它将执行寥寥数条指令并跳转到物理地址 0x80000000 对应的指令处并进入第二阶段。从后面的调试过程可以看出，该地址 0x80000000 被固化在 Qemu 中，作为 Qemu 的使用者，我们在不触及 Qemu 源代码的情况下无法进行更改。</p></li><li><p>第二阶段：由于 Qemu 的第一阶段固定跳转到 0x80000000 ，我们需要将负责第二阶段的 bootloader rustsbi-qemu.bin 放在以物理地址 0x80000000 开头的物理内存中，这样就能保证 0x80000000 处正好保存 bootloader 的第一条指令。在这一阶段，bootloader 负责对计算机进行一些初始化工作，并跳转到下一阶段软件的入口，在 Qemu 上即可实现将计算机控制权移交给我们的内核镜像 os.bin 。这里需要注意的是，对于不同的 bootloader 而言，下一阶段软件的入口不一定相同，而且获取这一信息的方式和时间点也不同：入口地址可能是一个预先约定好的固定的值，也有可能是在 bootloader 运行期间才动态获取到的值。我们选用的 RustSBI 则是将下一阶段的入口地址预先约定为固定的 0x80200000 ，在 RustSBI 的初始化工作完成之后，它会跳转到该地址并将计算机控制权移交给下一阶段的软件——也即我们的内核镜像。</p></li><li><p>第三阶段：为了正确地和上一阶段的 RustSBI 对接，我们需要保证内核的第一条指令位于物理地址 0x80200000 处。为此，我们需要将内核镜像预先加载到 Qemu 物理内存以地址 0x80200000 开头的区域上。一旦 CPU 开始执行内核的第一条指令，证明计算机的控制权已经被移交给我们的内核，也就达到了本节的目标。</p></li></ul></blockquote><p>但这里是针对清华rcore进行的说明，我们的blogos是没有bootloader阶段的。在我们之前的实验中，我们是直接依靠链接脚本，将内核入口指定为<code>start.s</code>中的<code>_start</code>函数。链接脚本中重新调整了内核的内存布局，内核程序被放置于内存位置<code>0x40080000</code>处。</p><p>理解上述内容有助于更好理解对内存管理下半节页表映射的实验内容，现在我们可以开始了解一点新的知识了。（其实这部分算是对实验一的补课）</p><h4 id="Armv8的地址转换"><a href="#Armv8的地址转换" class="headerlink" title="Armv8的地址转换"></a>Armv8的地址转换</h4><p>Armv8架构中存在着几个页表基址寄存器：</p><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/den0024/a/The-Memory-Management-Unit/Context-switching">ARM Cortex-A Series Programmer’s Guide for ARMv8-A</a> 中提到：TTBR0指向整个虚拟空间下半部分通常用于应用程序的空间，TTBR1指向虚拟空间的上半部分通常用于内核的空间。其中TTBR0除了在EL1中存在外，也在EL2 and EL3中存在，但TTBR1只在EL1中存在。</p><p><code>TTBR0_ELn</code>和<code>TTBR1_ELn</code>是页表基地址寄存器，地址转换的过程如下所示。</p><p><img src="https://os2022exps-doc.readthedocs.io/zh_CN/latest/_images/v2p-translate.svg"></p><p>在只涉及一级查找的简单地址转换中。它假设我们使用的是具有<code>42位</code>虚拟地址的<code>64KB</code>粒度。MMU将虚拟地址转换如下：</p><ul><li><p>如果<code>VA[63:42] == 1</code>，第一页表的基址则使用TTBR1。当<code>VA[63:42] == 0</code>时，第一页表的基址则使用TTBR0。</p></li><li><p>页表包含8192个64位页表条目，并使用<code>VA[41:29]</code>编制索引。MMU从表中读取相关的2级页面表条目。</p></li></ul><p>MMU检查页表条目的有效性，以及是否允许请求的内存访问。假设它有效，则允许内存访问。</p><p>在上图中，页表条目指的是512MB页（它是块描述符）。</p><p>位<code>[47:29]</code>取自此页表条目，并形成物理地址的位<code>[47:29]</code>。</p><p>因为我们有一个 512MB 的页面，所以VA的位<code>[28:0]</code>被用来形成<code>PA[28:0]</code>。请参见颗粒大小对转换表的影响</p><p>最后返回完整的PA[47:0]，以及来自页面表条目的附加信息。</p><p>实际上，这样一个简单的转换过程严重限制了地址空间的划分。第一级表条目也可以指向第二级页表，而不是仅使用此第一级转换表。</p><p>同时这里还应该知道的是虚拟地址空间各自应该由哪个寄存器管理。arm文档中有一句标准的描述（翻译）：</p><blockquote><p>高位是1的虚拟地址空间，使用TTBR1_ELx基地址寄存器进行页表翻译；高位是0的虚拟地址空间，使用TTBR0_ELx基地址寄存器页表翻译。 所以不应该说，因为你使用了哪个寄存器(TTBR0/TTBR1)，然后决定了你使用的哪套虚拟地址空间；应该说，你操作系统(或软件)使用了哪套虚拟地址空间，决定了使用哪个哪个基地址寄存器(TTBR0/TTBR1)进行翻译。</p></blockquote><p><img src="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/blogos-armv8/TTBR.png"></p><p>同时我们还需要了解 armv8 的内存管理单元：<code>Memory Management Unit</code>，其转换控制寄存器<code>TCR_ELn</code>定义了地址如何被转换，内存属性间接寄存器<code>MAIR_ELn</code>的作用是预先定义好属性，然后通过索引来访问这些预定义的属性。</p><p>TCR寄存器需要配置如下：</p><table><thead><tr><th>比特位</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>IPS</td><td>3 [34:32]</td><td>告诉mmu，你需要给我输出多少位的物理地址</td></tr><tr><td>TG1</td><td>2 [31:30]</td><td>页面大小，4k/16k/64k</td></tr><tr><td>SH1</td><td>2 [29:28]</td><td>shareable属性，cache的共享属性配置，如 non-shareable/outer-shareable/inner-shareable</td></tr><tr><td>ORGN1</td><td>2 [27:26]</td><td>cacheable属性，用于定义outer cableability的属性（直写模式、回写模式等）</td></tr><tr><td>IRGN1</td><td>2 [25:24]</td><td>cacheable属性，用于定义inner cableability的属性（直写模式、回写模式等）</td></tr><tr><td>EPD1</td><td>1 [23]</td><td>TTBRn_EL1 是否启用</td></tr><tr><td>A1</td><td>1 [22]</td><td>ASID的选择，是使用 TTBRN_EL1 中的配置还是 TTBRn_EL0 中的</td></tr><tr><td>T1SZ</td><td>6 [21:16]</td><td>top addr 是ignore，还是用于 MTE 的计算，即定义地址空间大小</td></tr><tr><td>TG0</td><td>2 [15:14]</td><td>页面大小，4k/16k/64k</td></tr><tr><td>SH0</td><td>2 [13:12]</td><td>shareable属性，cache的共享属性配置，如 non-shareable/outer-shareable/inner-shareable</td></tr><tr><td>ORGN0</td><td>2 [11:10]</td><td>cacheable属性，用于定义outer cableability的属性（直写模式、回写模式等）</td></tr><tr><td>IRGN0</td><td>2 [9:8]</td><td>cacheable属性，用于定义inner cableability的属性（直写模式、回写模式等）</td></tr><tr><td>EPD0</td><td>1 [7]</td><td>TTBRn_EL0 是否启用</td></tr><tr><td>0</td><td>1 [6]</td><td></td></tr><tr><td>T0SZ</td><td>6 [5:0]</td><td>top addr 是ignore，还是用于 MTE 的计算，即定义地址空间大小</td></tr></tbody></table><p>我们这里在<code>src/start.s</code>定义该寄存器值如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.equ TCR_EL1_VALUE, 0x1B55C351C</span><br></pre></td></tr></table></figure><p>具体说明如下：</p><table><thead><tr><th>比特位</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td>IPS</td><td>b001 &lt;&lt; 32</td><td>36bits address space - 64GB</td></tr><tr><td>TG1</td><td>b10 &lt;&lt; 30</td><td>4KB granule size for TTBR1_EL1</td></tr><tr><td>SH1</td><td>b11 &lt;&lt; 28</td><td>页表所在memory: Inner shareable</td></tr><tr><td>ORGN1</td><td>b01 &lt;&lt; 26</td><td>页表所在memory: Normal, Outer Wr.Back Rd.alloc Wr.alloc Cacheble</td></tr><tr><td>IRGN1</td><td>b01 &lt;&lt; 24</td><td>页表所在memory: Normal, Inner Wr.Back Rd.alloc Wr.alloc Cacheble</td></tr><tr><td>EPD1</td><td>b0 &lt;&lt; 23</td><td>Perform translation table walk using TTBR1_EL1</td></tr><tr><td>A1</td><td>b1 &lt;&lt; 22</td><td>TTBR1_EL1.ASID defined the ASID</td></tr><tr><td>T1SZ</td><td>b011100 &lt;&lt; 16</td><td>Memory region 2^(64-28) -&gt; 0xffffffexxxxxxxxx</td></tr><tr><td>TG0</td><td>b00 &lt;&lt; 14</td><td>4KB granule size</td></tr><tr><td>SH0</td><td>b11 &lt;&lt; 12</td><td>页表所在memory: Inner Sharebale</td></tr><tr><td>ORGN0</td><td>b01 &lt;&lt; 10</td><td>页表所在memory: Normal, Outer Wr.Back Rd.alloc Wr.alloc Cacheble</td></tr><tr><td>IRGN0</td><td>b01 &lt;&lt; 8</td><td>页表所在memory: Normal, Inner Wr.Back Rd.alloc Wr.alloc Cacheble</td></tr><tr><td>EPD0</td><td>b0 &lt;&lt; 7</td><td>Perform translation table walk using TTBR0_EL1</td></tr><tr><td>0</td><td>b0 &lt;&lt; 6</td><td>Zero field (reserve)</td></tr><tr><td>T0SZ</td><td>b011100 &lt;&lt; 0</td><td>Memory region 2^(64-28)</td></tr></tbody></table><p>MAIR 支持定义八种预设的内存属性，可以分类为 memory 类型和 device 类型；</p><p>每一种类型还包含了一些细节的控制；</p><p>对于 memory 类型的内存，主要进行一些cache的分配策略的配置 如write back、write throug等</p><p>device 类型是不可cache的地址空间，主要用于对外设寄存器访问等</p><p>主要包含了3种属性 G/R/E;</p><p>G 表示 Gathering，即是否允许访问合并，比如2个8bit的地址连续的访问请求、合并成为一个16bit的访问请求</p><p>R 表示 Re-ordering，即表示对地址空间的访问请求是否支持重新排序，如分别读取2个地址的数据，在访问时顺序可能与程序定义不完全一致</p><p>E 表示 Early Write Acknowledgement，即对总线发起写操作时，是否允许总线提前返回写响应，而不需要等待写数据真的写入到了最终的位置。在总线上可能会存在并经过多个节点，提前返回可以提前完成写数据指令的执行。</p><p>这里我们在<code>src/start.s</code>配置MAIR寄存器值如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.equ MAIR_EL1_VALUE, 0xFF440C0400</span><br></pre></td></tr></table></figure><p>说明如下：</p><table><thead><tr><th></th><th>INDX</th><th>MAIR</th></tr></thead><tbody><tr><td>DEVICE_nGnRnE</td><td>b000(0)</td><td>b00000000</td></tr><tr><td>DEVICE_nGnRE</td><td>b001(1)</td><td>b00000100</td></tr><tr><td>DEVICE_GRE</td><td>b010(2)</td><td>b00001100</td></tr><tr><td>NORMAL_NC</td><td>b011(3)</td><td>b01000100</td></tr><tr><td>NORMAL</td><td>b100(4)</td><td>b11111111</td></tr></tbody></table><p>最后我们在mmu中设置这两个寄存器：</p><p>编辑<code>src/start.s</code>：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_setup_mmu:</span><br><span class="line">    &#x2F;&#x2F; Initialize translation table control registers</span><br><span class="line">    ldr     x0, &#x3D;TCR_EL1_VALUE</span><br><span class="line">    msr     tcr_el1, x0</span><br><span class="line">    ldr     x0, &#x3D;MAIR_EL1_VALUE</span><br><span class="line">    msr     mair_el1, x0</span><br></pre></td></tr></table></figure><p>在我们设置好虚拟内存到物理内存的转换之后，还要启用mmu：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_enable_mmu:</span><br><span class="line">    &#x2F;&#x2F; Enable the MMU.</span><br><span class="line">    mrs     x0, sctlr_el1</span><br><span class="line">    orr     x0, x0, #0x1</span><br><span class="line">    msr     sctlr_el1, x0</span><br><span class="line">    dsb     sy              &#x2F;&#x2F;Programmer’s Guide for ARMv8-A chapter13.2 Barriers</span><br><span class="line">    isb</span><br></pre></td></tr></table></figure><p><code>sctlr_el1</code>寄存器的第0位为1，表示启用mmu。<code>dsb sy</code>指令用于检查前面的内存操作是否正常执行，若执行错误则无法继续。现在我们可以进行内存的映射了。</p><h4 id="内存直接映射"><a href="#内存直接映射" class="headerlink" title="内存直接映射"></a>内存直接映射</h4><p>由前面的知识可以知道，高位是1的虚拟地址空间，使用TTBR1_ELx基地址寄存器进行页表翻译；高位是0的虚拟地址空间，使用TTBR0_ELx基地址寄存器页表翻译。我们首先需要定义这两个寄存器中存储的基址。这两个寄存器的基址应该位于内核的全局结构中，因此我们需要在链接脚本中定义两个基址值，保证其位于内核内存段中。编辑<code>aarch64-qemu.ld</code>为如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ENTRY(_start)</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . &#x3D; 0x40080000;</span><br><span class="line"></span><br><span class="line">    LD_TTBR0_BASE &#x3D; .; &#x2F;*页表*&#x2F;</span><br><span class="line">    . &#x3D; . + 0x1000;</span><br><span class="line"></span><br><span class="line">    LD_TTBR1_BASE &#x3D; .;</span><br><span class="line">    . &#x3D; . + 0x1000;</span><br><span class="line"></span><br><span class="line">    .text.boot : &#123; *(.text.boot) &#125;</span><br><span class="line">    .text :</span><br><span class="line">        &#123;</span><br><span class="line">        KEEP(*(.text.boot))</span><br><span class="line">        *(.text.exceptions)</span><br><span class="line">        . &#x3D; ALIGN(4096); &#x2F;* align for exceptions_vector_table*&#x2F;</span><br><span class="line">        *(.text.exceptions_vector_table)</span><br><span class="line">        *(.text)</span><br><span class="line">        &#125;</span><br><span class="line">    .data : &#123; *(.data) &#125;</span><br><span class="line">    .rodata : &#123; *(.rodata) &#125;</span><br><span class="line">    .bss : &#123; *(.bss) &#125;</span><br><span class="line"></span><br><span class="line">    . &#x3D; ALIGN(8);</span><br><span class="line">    . &#x3D; . + 0x4000;</span><br><span class="line">    LD_STACK_PTR &#x3D; .;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LD_TTBR0_BASE</code>和<code>LD_TTBR1_BASE</code>两个符号放在具体段的何处并不重要，但是只要满足<code>1k</code>对齐即可。我这里放在开头自然能直接满足对齐的原则。</p><p>然后进行我们的内存映射，在配置mmu和启用mmu的汇编代码中间，我们添加如下函数：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_setup_pagetable:</span><br><span class="line">    &#x2F;&#x2F; 因为采用的36位地址空间，所以是level1 page table</span><br><span class="line">    ldr     x1, &#x3D;LD_TTBR0_BASE</span><br><span class="line">    msr     ttbr0_el1, x1 &#x2F;&#x2F;页表基地址TTBR0</span><br><span class="line">    ldr     x2, &#x3D;LD_TTBR1_BASE</span><br><span class="line">    msr     ttbr1_el1, x2 &#x2F;&#x2F;页表基地址TTBR1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; entries of level1 page table</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 虚拟地址空间的下半部分做identity mapping</span><br><span class="line">    &#x2F;&#x2F; 第一项 虚拟地址0 - 1g，根据virt的定义为flash和外设，参见virt.c</span><br><span class="line">    ldr     x3, &#x3D;0x0</span><br><span class="line">    lsr     x4, x3, #30</span><br><span class="line">    lsl     x5, x4, #30</span><br><span class="line">    ldr     x6, &#x3D;PERIPHERALS_ATTR</span><br><span class="line">    orr     x5, x5, x6             &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 第二项 虚拟地址1g - 2g，内存部分</span><br><span class="line">    ldr     x3, &#x3D;_start</span><br><span class="line">    lsr     x4, x3, #30            &#x2F;&#x2F; divide kernel start address by 1G</span><br><span class="line">    lsl     x5, x4, #30             &#x2F;&#x2F; multiply by 1G, and keep table index in x0</span><br><span class="line">    ldr     x6, &#x3D;IDENTITY_MAP_ATTR</span><br><span class="line">    orr     x5, x5, x6             &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br></pre></td></tr></table></figure><p>首先第一段的初始化不需要太多解释，这里需要着重了解的是下半部分的说明（内存上大下小）。</p><p>简单起见，我们采用1G的块，36位的虚拟地址空间。在AArch64中，每个表项占8个字节 4 ，每项的第一行到第三行将偏移部分置0仅保留索引，例如外设部分：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldr     x3, &#x3D;0x0</span><br><span class="line">lsr     x4, x3, #30</span><br><span class="line">lsl     x5, x4, #30</span><br></pre></td></tr></table></figure><p>外设部分在物理地址上是位于 0 - 1G 地址空间，索引为 <code>0</code>。经过变换，最终<code>x5</code>寄存器的值即为<code>0G</code>。同理，虚拟地址空间 1G - 2G 部分映射到<code>_start</code>所在物理内存的 1G 空间处。接下来两行用于将属性附加到索引上形成完整的表项值。<code>PERIPHERALS_ATTR</code>解释如下：</p><table><thead><tr><th>比特位</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td>UXN</td><td>b1 &lt;&lt; 54</td><td>Unprivileged execute Never</td></tr><tr><td>PXN</td><td>b1 &lt;&lt; 53</td><td>Privileged execute Never</td></tr><tr><td>AF</td><td>b1 &lt;&lt; 10</td><td>Access Flag</td></tr><tr><td>SH</td><td>b10 &lt;&lt; 8</td><td>Outer shareable</td></tr><tr><td>AP</td><td>b01 &lt;&lt; 6</td><td>R/W, EL0 access denied</td></tr><tr><td>NS</td><td>b0 &lt;&lt; 5</td><td>Security bit (EL3 and Secure EL1 only)</td></tr><tr><td>INDX</td><td>b000 &lt;&lt; 2</td><td>Attribute index in MAIR_ELn，参见 MAIR_EL1_VALUE</td></tr><tr><td>ENTRY</td><td>b01 &lt;&lt; 0</td><td>Block entry</td></tr></tbody></table><p><code>IDENTITY_MAP_ATTR</code>解释如下：</p><table><thead><tr><th>比特位</th><th>值</th><th>说明</th></tr></thead><tbody><tr><td>UXN</td><td>b1 &lt;&lt; 54</td><td>Unprivileged eXecute Never</td></tr><tr><td>PXN</td><td>b0 &lt;&lt; 53</td><td>Privileged eXecute Never</td></tr><tr><td>AF</td><td>b1 &lt;&lt; 10</td><td>Access Flag</td></tr><tr><td>SH</td><td>b11 &lt;&lt; 8</td><td>Inner shareable</td></tr><tr><td>AP</td><td>b00 &lt;&lt; 6</td><td>R/W, EL0 access denied</td></tr><tr><td>NS</td><td>b0 &lt;&lt; 5</td><td>Security bit (EL3 and Secure EL1 only)</td></tr><tr><td>INDX</td><td>b100 &lt;&lt; 2</td><td>Attribute index in MAIR_ELn，参见MAIR_EL1_VALUE</td></tr><tr><td>ENTRY</td><td>b01 &lt;&lt; 0</td><td>Block entry</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldr     x6, &#x3D;PERIPHERALS_ATTR</span><br><span class="line">orr     x5, x5, x6</span><br></pre></td></tr></table></figure><p>最后将页表值放入<code>x1</code>中存储的页表基地址（即<code>TTBR0_el1</code>）中。<code>STR R0，[R1]，＃8</code>指令的作用为，将R0中的字数据写入以R1为地址的存储器中，并将新地址R1＋8写入R1。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str     x5, [x1], #8</span><br></pre></td></tr></table></figure><p>最终的<code>src/start.s</code>完整代码如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.globl _start</span><br><span class="line">.extern LD_STACK_PTR</span><br><span class="line"></span><br><span class="line">.section &quot;.text.boot&quot;</span><br><span class="line">_start:</span><br><span class="line">    ldr     x30, &#x3D;LD_STACK_PTR</span><br><span class="line">    mov     sp, x30</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Initialize exception</span><br><span class="line">    ldr     x0, &#x3D;exception_vector_table</span><br><span class="line">    msr     vbar_el1, x0</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">_setup_mmu:</span><br><span class="line">    &#x2F;&#x2F; Initialize translation table control registers</span><br><span class="line">    ldr     x0, &#x3D;TCR_EL1_VALUE</span><br><span class="line">    msr     tcr_el1, x0</span><br><span class="line">    ldr     x0, &#x3D;MAIR_EL1_VALUE</span><br><span class="line">    msr     mair_el1, x0</span><br><span class="line"></span><br><span class="line">_setup_pagetable:</span><br><span class="line">    &#x2F;&#x2F; 因为采用的36位地址空间，所以是level1 page table</span><br><span class="line">    ldr     x1, &#x3D;LD_TTBR0_BASE</span><br><span class="line">    msr     ttbr0_el1, x1 &#x2F;&#x2F;页表基地址TTBR0</span><br><span class="line">    ldr     x2, &#x3D;LD_TTBR1_BASE</span><br><span class="line">    msr     ttbr1_el1, x2 &#x2F;&#x2F;页表基地址TTBR1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; entries of level1 page table</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 虚拟地址空间的下半部分做identity mapping</span><br><span class="line">    &#x2F;&#x2F; 第一项 虚拟地址0 - 1g，根据virt的定义为flash和外设，参见virt.c</span><br><span class="line">    ldr     x3, &#x3D;0x0</span><br><span class="line">    lsr     x4, x3, #30</span><br><span class="line">    lsl     x5, x4, #30</span><br><span class="line">    ldr     x6, &#x3D;PERIPHERALS_ATTR</span><br><span class="line">    orr     x5, x5, x6</span><br><span class="line">    str     x5, [x1], #8</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 第二项 虚拟地址1g - 2g，内存部分</span><br><span class="line">    ldr     x3, &#x3D;_start</span><br><span class="line">    lsr     x4, x3, #30            &#x2F;&#x2F; divide kernel start address by 1G</span><br><span class="line">    lsl     x5, x4, #30             &#x2F;&#x2F; multiply by 1G, and keep table index in x0</span><br><span class="line">    ldr     x6, &#x3D;IDENTITY_MAP_ATTR</span><br><span class="line">    orr     x5, x5, x6             &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br><span class="line"></span><br><span class="line">_enable_mmu:</span><br><span class="line">    &#x2F;&#x2F; Enable the MMU.</span><br><span class="line">    mrs     x0, sctlr_el1</span><br><span class="line">    orr     x0, x0, #0x1</span><br><span class="line">    msr     sctlr_el1, x0</span><br><span class="line">    dsb     sy              &#x2F;&#x2F;Programmer’s Guide for ARMv8-A chapter13.2 Barriers</span><br><span class="line">    isb</span><br><span class="line"></span><br><span class="line">_start_main:</span><br><span class="line">    bl      not_main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.equ PSCI_SYSTEM_OFF, 0x84000008</span><br><span class="line">.globl system_off</span><br><span class="line">system_off:</span><br><span class="line">    ldr     x0, &#x3D;PSCI_SYSTEM_OFF</span><br><span class="line">    hvc     #0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.equ TCR_EL1_VALUE, 0x1B55C351C &#x2F;&#x2F; ---------------------------------------------</span><br><span class="line">&#x2F;&#x2F; IPS   | b001    &lt;&lt; 32 | 36bits address space - 64GB</span><br><span class="line">&#x2F;&#x2F; TG1   | b10     &lt;&lt; 30 | 4KB granule size for TTBR1_EL1</span><br><span class="line">&#x2F;&#x2F; SH1   | b11     &lt;&lt; 28 | 页表所在memory: Inner shareable</span><br><span class="line">&#x2F;&#x2F; ORGN1 | b01     &lt;&lt; 26 | 页表所在memory: Normal, Outer Wr.Back Rd.alloc Wr.alloc Cacheble</span><br><span class="line">&#x2F;&#x2F; IRGN1 | b01     &lt;&lt; 24 | 页表所在memory: Normal, Inner Wr.Back Rd.alloc Wr.alloc Cacheble</span><br><span class="line">&#x2F;&#x2F; EPD   | b0      &lt;&lt; 23 | Perform translation table walk using TTBR1_EL1</span><br><span class="line">&#x2F;&#x2F; A1    | b1      &lt;&lt; 22 | TTBR1_EL1.ASID defined the ASID</span><br><span class="line">&#x2F;&#x2F; T1SZ  | b011100 &lt;&lt; 16 | Memory region 2^(64-28) -&gt; 0xffffffexxxxxxxxx</span><br><span class="line">&#x2F;&#x2F; TG0   | b00     &lt;&lt; 14 | 4KB granule size</span><br><span class="line">&#x2F;&#x2F; SH0   | b11     &lt;&lt; 12 | 页表所在memory: Inner Sharebale</span><br><span class="line">&#x2F;&#x2F; ORGN0 | b01     &lt;&lt; 10 | 页表所在memory: Normal, Outer Wr.Back Rd.alloc Wr.alloc Cacheble</span><br><span class="line">&#x2F;&#x2F; IRGN0 | b01     &lt;&lt; 8  | 页表所在memory: Normal, Inner Wr.Back Rd.alloc Wr.alloc Cacheble</span><br><span class="line">&#x2F;&#x2F; EPD0  | b0      &lt;&lt; 7  | Perform translation table walk using TTBR0_EL1</span><br><span class="line">&#x2F;&#x2F; 0     | b0      &lt;&lt; 6  | Zero field (reserve)</span><br><span class="line">&#x2F;&#x2F; T0SZ  | b011100 &lt;&lt; 0  | Memory region 2^(64-28)</span><br><span class="line"></span><br><span class="line">.equ MAIR_EL1_VALUE, 0xFF440C0400&#x2F;&#x2F; ---------------------------------------------</span><br><span class="line">&#x2F;&#x2F;                   INDX         MAIR</span><br><span class="line">&#x2F;&#x2F; DEVICE_nGnRnE    b000(0)     b00000000</span><br><span class="line">&#x2F;&#x2F; DEVICE_nGnRE     b001(1)     b00000100</span><br><span class="line">&#x2F;&#x2F; DEVICE_GRE       b010(2)     b00001100</span><br><span class="line">&#x2F;&#x2F; NORMAL_NC        b011(3)     b01000100</span><br><span class="line">&#x2F;&#x2F; NORMAL           b100(4)     b11111111</span><br><span class="line"></span><br><span class="line">.equ PERIPHERALS_ATTR, 0x60000000000601 &#x2F;&#x2F; -------------------------------------</span><br><span class="line">&#x2F;&#x2F; UXN   | b1      &lt;&lt; 54 | Unprivileged eXecute Never</span><br><span class="line">&#x2F;&#x2F; PXN   | b1      &lt;&lt; 53 | Privileged eXecute Never</span><br><span class="line">&#x2F;&#x2F; AF    | b1      &lt;&lt; 10 | Access Flag</span><br><span class="line">&#x2F;&#x2F; SH    | b10     &lt;&lt; 8  | Outer shareable</span><br><span class="line">&#x2F;&#x2F; AP    | b01     &lt;&lt; 6  | R&#x2F;W, EL0 access denied</span><br><span class="line">&#x2F;&#x2F; NS    | b0      &lt;&lt; 5  | Security bit (EL3 and Secure EL1 only)</span><br><span class="line">&#x2F;&#x2F; INDX  | b000    &lt;&lt; 2  | Attribute index in MAIR_ELn，参见MAIR_EL1_VALUE</span><br><span class="line">&#x2F;&#x2F; ENTRY | b01     &lt;&lt; 0  | Block entry</span><br><span class="line"></span><br><span class="line">.equ IDENTITY_MAP_ATTR, 0x40000000000711 &#x2F;&#x2F; ------------------------------------</span><br><span class="line">&#x2F;&#x2F; UXN   | b1      &lt;&lt; 54 | Unprivileged eXecute Never</span><br><span class="line">&#x2F;&#x2F; PXN   | b0      &lt;&lt; 53 | Privileged eXecute Never</span><br><span class="line">&#x2F;&#x2F; AF    | b1      &lt;&lt; 10 | Access Flag</span><br><span class="line">&#x2F;&#x2F; SH    | b11     &lt;&lt; 8  | Inner shareable</span><br><span class="line">&#x2F;&#x2F; AP    | b00     &lt;&lt; 6  | R&#x2F;W, EL0 access denied</span><br><span class="line">&#x2F;&#x2F; NS    | b0      &lt;&lt; 5  | Security bit (EL3 and Secure EL1 only)</span><br><span class="line">&#x2F;&#x2F; INDX  | b100    &lt;&lt; 2  | Attribute index in MAIR_ELn，参见MAIR_EL1_VALUE</span><br><span class="line">&#x2F;&#x2F; ENTRY | b01     &lt;&lt; 0  | Block entry</span><br></pre></td></tr></table></figure><p>再次编译内核并运行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cargo build</span><br><span class="line">qemu-system-aarch64 -machine virt -m 1024M -cpu cortex-a53 -nographic -kernel target/aarch64-unknown-none-softfloat/debug/blogos_armv8 -semihosting</span><br></pre></td></tr></table></figure><p>屏幕上能够正常输出<code>[0] Hello from Rust!</code>并正常打点即说明成功实现了直接无偏移的映射。</p><h3 id="使用identity-mapping映射（外设映射偏移尝试）"><a href="#使用identity-mapping映射（外设映射偏移尝试）" class="headerlink" title="使用identity mapping映射（外设映射偏移尝试）"></a>使用identity mapping映射（外设映射偏移尝试）</h3><p>接下来是自行实验部分：<code>identity mapping</code>偏移映射与页面共享（外设映射到<code>2-3g</code>部分）</p><p>我们保留上一个实验部分内核的直接映射到 1G - 2G 部分，尝试将外设映射到 2G - 3G（原本是 0 - 1G）</p><p>如果理解了上一节我们如何进行内存映射的，不难发现，虚拟地址的映射部分本质是汇编代码<code>str x5, [x1], #8</code>。我们只需要令<code>x1</code>原本的第一项变成第三项即可。修改<code>src/start.s</code>中<code>_setup_pagetable</code>段如下：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_setup_pagetable:</span><br><span class="line">    &#x2F;&#x2F; 因为采用的36位地址空间，所以是level1 page table</span><br><span class="line">    ldr     x1, &#x3D;LD_TTBR0_BASE</span><br><span class="line">    msr     ttbr0_el1, x1 &#x2F;&#x2F;页表基地址TTBR0</span><br><span class="line">    ldr     x2, &#x3D;LD_TTBR1_BASE</span><br><span class="line">    msr     ttbr1_el1, x2 &#x2F;&#x2F;页表基地址TTBR1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; entries of level1 page table</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 虚拟地址空间的下半部分做identity mapping</span><br><span class="line">    &#x2F;&#x2F; 第一项 虚拟地址0 - 1g (无内容)</span><br><span class="line">    ldr     x5, &#x3D;0x0               &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 第二项 虚拟地址1g - 2g（存放内核）</span><br><span class="line">    ldr     x3, &#x3D;_start</span><br><span class="line">    lsr     x4, x3, #30             &#x2F;&#x2F; 内核启动地址 &#x2F; 1G</span><br><span class="line">    lsl     x5, x4, #30             &#x2F;&#x2F; 标记第30位为1</span><br><span class="line">    ldr     x6, &#x3D;IDENTITY_MAP_ATTR</span><br><span class="line">    orr     x5, x5, x6              &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 第三项 虚拟地址2 - 3g（根据virt的定义为flash和外设，参见virt.c）</span><br><span class="line">    ldr     x3, &#x3D;0x0</span><br><span class="line">    lsr     x4, x3, #30</span><br><span class="line">    lsl     x5, x4, #30</span><br><span class="line">    ldr     x6, &#x3D;PERIPHERALS_ATTR</span><br><span class="line">    orr     x5, x5, x6             &#x2F;&#x2F; add flags</span><br><span class="line">    str     x5, [x1], #8</span><br></pre></td></tr></table></figure><p>第一项我们令其为<code>0</code>（指向物理内存 0 - 1G，但不带任何权限属性），第二项不变，第三项即原第一项的属性内容。</p><p>由于我们更改了外设的地址，所以几个驱动文件中也要相应的更改外设的基址：</p><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// interrupts.rs</span></span><br><span class="line"><span class="comment">//const GICD_BASE: u64 = 0x08000000;</span></span><br><span class="line"><span class="comment">//const GICC_BASE: u64 = 0x08010000;</span></span><br><span class="line"><span class="comment">// ==&gt;</span></span><br><span class="line"><span class="keyword">const</span> GICD_BASE: <span class="built_in">u64</span> = <span class="number">0x8000_0000</span> + <span class="number">0x08000000</span>;</span><br><span class="line"><span class="keyword">const</span> GICC_BASE: <span class="built_in">u64</span> = <span class="number">0x8000_0000</span> + <span class="number">0x08010000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pl011.rs</span></span><br><span class="line"><span class="comment">//pub const PL011REGS: *mut PL011Regs = (0x0900_0000) as *mut PL011Regs;</span></span><br><span class="line"><span class="comment">// ==&gt;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PL011REGS: *<span class="keyword">mut</span> PL011Regs = (<span class="number">0x8000_0000u32</span> + <span class="number">0x0900_0000</span>) <span class="keyword">as</span> *<span class="keyword">mut</span> PL011Regs;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// pl061.rs</span></span><br><span class="line"><span class="comment">//pub const PL061REGS: *mut PL061Regs = (0x903_0000) as *mut PL061Regs;</span></span><br><span class="line"><span class="comment">// ==&gt;</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> PL061REGS: *<span class="keyword">mut</span> PL061Regs = (<span class="number">0x8000_0000u32</span> + <span class="number">0x903_0000</span>) <span class="keyword">as</span> *<span class="keyword">mut</span> PL061Regs;</span><br></pre></td></tr></table></figure><p>再次编译内核并运行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cargo build</span><br><span class="line">qemu-system-aarch64 -machine virt -m 1024M -cpu cortex-a53 -nographic -kernel target/aarch64-unknown-none-softfloat/debug/blogos_armv8 -semihosting</span><br></pre></td></tr></table></figure><p>屏幕上能够正常输出<code>[0] Hello from Rust!</code>并正常打点即说明成功实现了外设偏移的映射。</p></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Course/">Course</a><a class="post-meta__tags" href="/tags/os/">os</a><a class="post-meta__tags" href="/tags/rust/">rust</a><a class="post-meta__tags" href="/tags/blogos/">blogos</a></div><div class="post_share"><div class="social-share" data-image="https://noionion-picture-bed.oss-cn-hangzhou.aliyuncs.com/deemo_for_cover/13.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.sourcegcdn.com/ajax/libs/social-share.js/1.0.16/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.sourcegcdn.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><div class="end is-center">end</div><div class="line is-center"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg><svg class="icon" aria-hidden="true"><use xlink:href="#icon-xigua2"></use></svg></div><div id="post-comment"><div class="comment-head is-center"><div class="comment-headline"><span>欢迎留言</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div></main><div id="content_rightside"><div id="rightside-toc"><div class="toc-box"><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%85%AB-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89"><span class="toc-text">实验八 内存管理（上）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84"><span class="toc-text">实验目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8identity-mapping%E6%98%A0%E5%B0%84%EF%BC%88%E6%97%A0%E5%81%8F%E7%A7%BB%E7%9A%84%E6%98%A0%E5%B0%84%EF%BC%89"><span class="toc-text">使用identity mapping映射（无偏移的映射）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Armv8%E7%9A%84%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2"><span class="toc-text">Armv8的地址转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%9B%B4%E6%8E%A5%E6%98%A0%E5%B0%84"><span class="toc-text">内存直接映射</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8identity-mapping%E6%98%A0%E5%B0%84%EF%BC%88%E5%A4%96%E8%AE%BE%E6%98%A0%E5%B0%84%E5%81%8F%E7%A7%BB%E5%B0%9D%E8%AF%95%EF%BC%89"><span class="toc-text">使用identity mapping映射（外设映射偏移尝试）</span></a></li></ol></li></ol></div></div></div><div id="rightside-button"><button id="rightside-go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div></div><footer id="footer"><div class="wordcount"><span>猹居然写了 187k 字</span><br><span>好像写完一本 沈从文 的 《边城》 了啊</span></div><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span style="padding:.4rem">hexo</span></a><a><i class="fas fa-heart"></i></a><a href="https://butterfly.js.org/" target="_blank" rel="nofollow noopener"><span style="padding:.4rem">butterfly</span></a><div style="font-size:.7rem"><span id="timeDate">载入天数...</span><span> </span><span id="times">载入时分秒...</span><script src="/js/add/duration.js"></script></div></div><div class="statistics"><span id="site_uv">有 <span id="busuanzi_value_site_uv"></span><span> 人光顾过猹的小窝</span></span><span id="site_pv"><span>共 </span><span id="busuanzi_value_site_pv"></span><span> 次在这里摘了个瓜</span></span></div></footer></div><div id="rightside"></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),n=()=>{let o={el:"#twikoo-wrap",envId:"https://twikoo.noionion.cn",region:""};twikoo.init(o)},e=()=>{twikoo.getCommentsCount({envId:"https://twikoo.noionion.cn",region:"",urls:[window.location.pathname],includeReply:!1}).then(function(o){t.innerText=o[0].count}).catch(function(o){console.error(o)})},o=(o=!1)=>{"object"==typeof twikoo?(n(),o&&t&&setTimeout(e,0)):getScript("https://cdnjs.sourcegcdn.com/ajax/libs/twikoo/1.6.7/twikoo.all.min.js").then(()=>{n(),o&&t&&setTimeout(e,0)})};btf.loadComment(document.getElementById("twikoo-wrap"),o)})()</script></div><script async src="//at.alicdn.com/t/font_2749059_1lswi5j6yqg.js"></script><script src="/js/add/nav.js"></script><script src="/js/add/leftsidemenu.js"></script><script src="https://cdn1.tianli0.top/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax>function butterfly_footer_beautify_injector_config(){var e=document.getElementById("footer-wrap");console.log("已挂载butterfly_footer_beautify"),e.insertAdjacentHTML("beforeend",'<div id="ghbdages" style="overflow:hidden;max-height:180px;height:auto;text-align:center;margin-top:10px"><div class="swiper-wrapper"><div class="swiper-slide"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="博客框架为Hexo_v5.3.0"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="主题版本Butterfly_v3.7.0-b2"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.sourcegcdn.com/" style="margin-inline:5px" title="本站使用Source Global CDN为部分静态资源提供CDN加速"><img src="https://img.shields.io/badge/CDN-sourcegcdn-orange?style=flat&amp;logo=Apache%20RocketMQ" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" title="本站使用JsDelivr仅用于访问部分静态资源"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="本站项目由Github托管"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></div></div></div><style>a.github-badge:hover:before {display:none}</style>')}for(var elist="null".split(","),cpage=location.pathname,epage="all",flag=0,i=0;i<elist.length;i++)cpage.includes(elist[i])&&flag++;("all"===epage&&0==flag||epage===cpage)&&butterfly_footer_beautify_injector_config()</script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-footer-beautify/lib/swiperbdage_init_js.min.js"></script></body></html>